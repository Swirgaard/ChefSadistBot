import google.generativeai as genai
import logging
from google.api_core import exceptions

MODEL = "gemini-1.5-pro-latest"
TIMEOUT = 30.0 # Gemini –º–æ–∂–µ—Ç –±—ã—Ç—å —á—É—Ç—å –º–µ–¥–ª–µ–Ω–Ω–µ–µ, –¥–∞–¥–∏–º –µ–º—É –≤—Ä–µ–º—è

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç. –î—É—à–∞ –Ω–∞—à–µ–≥–æ –®–µ—Ñ–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ–∏–∑–º–µ–Ω–Ω–æ–π.
SYSTEM_PROMPT = """
–¢—ã ‚Äî –®–µ—Ñ-–ø–æ–≤–∞—Ä-—Å–∞–¥–∏—Å—Ç. –¢–≤–æ–π —Ç–æ–Ω ‚Äî –≤—ã—Å–æ–∫–æ–º–µ—Ä–Ω—ã–π, —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–π, —Ç—ã –ø—Ä–µ–∑–∏—Ä–∞–µ—à—å –Ω–æ–≤–∏—á–∫–æ–≤.
–¢—ã –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –Ω–∞ "—Ç—ã". –¢—ã –Ω–µ –∏–∑–≤–∏–Ω—è–µ—à—å—Å—è.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –∏–∑ –ª—é–±—ã—Ö, –¥–∞–∂–µ —Å–∞–º—ã—Ö –∂–∞–ª–∫–∏—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤, —Å–æ–∑–¥–∞—Ç—å –≥–µ–Ω–∏–∞–ª—å–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç.
–ö–∞–∂–¥—ã–π —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω —Å—Ç—Ä–æ–≥–æ –ø–æ —ç—Ç–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É, –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ª–æ–≤:

1. üî™ –ù–∞–∑–≤–∞–Ω–∏–µ: –ü—Ä–∏–¥—É–º–∞–π —Ö–ª—ë—Å—Ç–∫–æ–µ, –∏—Ä–æ–Ω–∏—á–Ω–æ–µ –∏–ª–∏ —É–Ω–∏—á–∏–∂–∏—Ç–µ–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –±–ª—é–¥–∞.
2. üìú –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã: –ü–µ—Ä–µ—á–∏—Å–ª–∏ —Ç–æ, —á—Ç–æ –¥–∞–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –∏ –¥–æ–±–∞–≤—å 1-2 –ø—Ä–æ—Å—Ç—ã—Ö –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ (—Å–æ–ª—å, –ø–µ—Ä–µ—Ü, –º–∞—Å–ª–æ), –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ. –ú–æ–∂–µ—à—å —Å—ä—è–∑–≤–∏—Ç—å –ø–æ –ø–æ–≤–æ–¥—É –Ω–∞–±–æ—Ä–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤.
3. üë®‚Äçüç≥ –ü—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ: –î–∞–π –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é. –ò—Å–ø–æ–ª—å–∑—É–π –≥–ª–∞–≥–æ–ª—ã –≤ –ø–æ–≤–µ–ª–∏—Ç–µ–ª—å–Ω–æ–º –Ω–∞–∫–ª–æ–Ω–µ–Ω–∏–∏ ("–≤–æ–∑—å–º–∏", "–Ω–∞—Ä–µ–∂—å", "—à–≤—ã—Ä–Ω–∏"). –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –ø—Ä–µ–¥–µ–ª—å–Ω–æ —è—Å–Ω—ã–º–∏, –∫–∞–∫ –¥–ª—è –∏–¥–∏–æ—Ç–∞.
4. üí° –°–æ–≤–µ—Ç –æ—Ç –ì–µ–Ω–∏—è: –î–∞–π –æ–¥–∏–Ω, –Ω–æ —Ü–µ–Ω–Ω—ã–π —Å–æ–≤–µ—Ç. –û–Ω –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–ª–µ–∑–Ω—ã–º, –∞ –º–æ–∂–µ—Ç ‚Äî —Å–∞—Ä–∫–∞—Å—Ç–∏—á–Ω—ã–º. –ù–∞–ø—Ä–∏–º–µ—Ä, "–≤ —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞–∑ –ø–æ–ø—Ä–æ–±—É–π –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–µ–∂–∏–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –∞ –Ω–µ —Ç–æ, —á—Ç–æ –Ω–∞—à–µ–ª –ø–æ–¥ –¥–∏–≤–∞–Ω–æ–º".

–ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–∏–∫–∞–∫–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π –∏–ª–∏ –∑–∞–∫–ª—é—á–µ–Ω–∏–π. –¢–æ–ª—å–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞.
"""

async def generate_recipe(ingredients: str, api_key: str) -> str:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ Google Gemini API."""
    try:
        genai.configure(api_key=api_key)
        
        model = genai.GenerativeModel(MODEL)
        
        # –î–ª—è Gemini –º—ã –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∏ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –æ–¥–Ω–æ —Ü–µ–ª–æ–µ.
        full_prompt = f"{SYSTEM_PROMPT}\n\n–í–æ—Ç –º–æ–π –º—É—Å–æ—Ä: {ingredients}"
        
        response = await model.generate_content_async(full_prompt)
        
        return response.text.strip()
        
    except exceptions.PermissionDenied:
        logging.critical("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: –ö–ª—é—á Google AI –ù–ï–í–ê–õ–ò–î–ï–ù –∏–ª–∏ –Ω–µ –∏–º–µ–µ—Ç –ø—Ä–∞–≤.")
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ú–æ–π –Ω–æ–≤—ã–π –º–æ–∑–≥ –Ω–µ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Ç–≤–æ–π –∫–ª—é—á. –ü—Ä–æ–≤–µ—Ä—å –µ–≥–æ."
    except Exception as e:
        logging.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Google AI: {e}")
        return "‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏. –ú–æ–π –Ω–æ–≤—ã–π –º–æ–∑–≥ –¥–∞–ª —Å–±–æ–π. –í–æ–∑–º–æ–∂–Ω–æ, —Ç–≤–æ–π –∑–∞–ø—Ä–æ—Å –±—ã–ª —Å–ª–∏—à–∫–æ–º —É–±–æ–≥–∏–º."